---
title: "Calculating NCI Comorbidity Index"
author: "Miriam Hu and Naichen Ni"
date: "Dec. 5, 2019"
output: ioslides_presentation
---

<style>
pre {
  font-size: 16pt;
}
</style>

```{r setup, include = FALSE}
library(knitr)
  opts_chunk$set(echo = FALSE, cache = TRUE, autodep = TRUE, 
                 message = FALSE, warning = FALSE)
library(tidyverse)
library(plyr)
library(comorbidity)
library(readxl)
```

```{r modify-codes, eval = FALSE}
# Modify ICD-9 codes to correspond with NCI categories ------ 
load(file = "sysdata.rda") # creates lofregex, a list of lists
mod <- lofregex # copy the list

mod$charlson$icd9$ami <- "^410" # ami is just 410

mod$charlson$icd9$histami <- "^412" # history of ami

mod$charlson$icd9$diab <- "^2500|^2501|^2502|^2503|^2508|^2509|^2504|^2505|^2506|^2507"# combine diabetes and diabetes with complications

mod$charlson$icd9$diabwc <- NULL # remove now useless diabwc

mod$charlson$icd9$ld <- "^07022|^07023|^07032|^07033|^07044|^07054|^0706|^0709|^570|^571|^5733|^5734|^5738|^5739|^V427|^4560|^4561|^4562|^5722|^5723|^5724|^5725|^5726|^5727|^5728" # combine mild and moderate/severe liver disease

mod$charlson$icd9$mld <- NULL # now defunct
mod$charlson$icd9$msld <- NULL # also now defunct

mod$charlson$icd9$canc <- NULL # remove cancer
mod$charlson$icd9$metacanc <- NULL # remove metastatic cancer

# Modify ICD-10 codes to correspond with NCI categories -----
mod$charlson$icd10$ami <- "^I21|^I22" # ami is just these two

mod$charlson$icd10$histami <- "^I252" # history of ami, I25.2

mod$charlson$icd10$diab <- "^E100|^E101|^E106|^E108|^E109|^E110|^E111|^E116|^E118|^E119|^E120|^E121|^E126|^E128|^E129|^E130|^E131|^E136|^E138|^E139|^E140|^E141|^E146|^E148|^E149|^E102|^E103|^E104|^E105|^E107|^E112|^E113|^E114|^E115|^E117|^E122|^E123|^E124|^E125|^E127|^E132|^E133|^E134|^E135|^E137|^E142|^E143|^E144|^E145|^E147"# combine diabetes and diabetes with complications

mod$charlson$icd10$diabwc <- NULL # remove now useless diabwc

mod$charlson$icd10$ld <- "^B18|^K700|^K701|^K702|^K703|^K709|^K713|^K714|^K715|^K717|^K73|^K74|^K760|^K762|^K763|^K764|^K768|^K769|^Z944|^I850|^I859|^I864|^I982|^K704|^K711|^K721|^K729|^K765|^K766|^K767" # combine mild and moderate/severe liver disease

mod$charlson$icd10$mld <- NULL # now defunct
mod$charlson$icd10$msld <- NULL # also now defunct

mod$charlson$icd10$canc <- NULL # remove cancer
mod$charlson$icd10$metacanc <- NULL # remove metastatic cancer

lofregex <- mod

# Reorder diseases according to NCI categories ---------
weights <- read_csv("weights.csv")
pattern <- weights$disease.category
lofregex$charlson$icd9 <- lofregex$charlson$icd9[pattern]
lofregex$charlson$icd10 <- lofregex$charlson$icd10[pattern]
```

## Introduction

**Charlson Comorbidity Index:** most widely used measure of comorbid diseases

- First created in 1987
- Ranges from 0 to 24
- Each comorbid disease is assigned to a weight according to risk of death.
- e.g. Diabetes or chronic liver disease add 1 point to the score, while metastatic cancer or AIDS contribute 6 points.
- R package **comorbidity** can calculate the Charlson.

What if your dataset only had cancer patients?

**NCI Comorbidity Index:**

- Excludes tumors, leukemias, and lymphomas
- Slightly different weighting scheme (e.g. kidney disease has a score of 1.60 instead of 2)

## Example Data

```{r example-data}
# Clean the example data and write to csv for presentation -----
# example <- read_csv("example_data.csv")
# example <- example %>% subset(DIAGNOSIS_CODE_TYPE == "ICD-10")
# example <- example %>% subset(select = -DIAGNOSIS_CODE_TYPE)
# example$id <- sample(example$PATIENT_ID)
# example <- example %>% subset(select = -PATIENT_ID)
# example <- example %>% select(id, everything())
# example <- example %>% arrange(id)
# write_csv(example, "example_data.csv")

example <- read_csv("example-data.csv")
kable(example[1:3, ])

cmb <- comorbidity(x = example, id = "id", code = "code", score = "charlson", assign0 = TRUE)
```

